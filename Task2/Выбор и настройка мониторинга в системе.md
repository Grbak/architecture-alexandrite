# Выбор и настройка мониторинга в системе

## Мотивация

Внедрение мониторинга обеспечит бОльшую надежность системы, что критически важно в контексте расширения бизнеса. Кроме того, мониторинг позволит лучше понимать, как растет нагрузка, и адаптировать систему к ней, что в конечном итоге будет положительно сказываться на производительности и общей удовлетворенности клиентов продуктом.

## Выбор подхода к мониторингу

Для MES API, CRM API и Shop API применим подход The Four Golden Signals, так как он отлично подходит для API-сервисов и позволяет обнаруживать возникающие в связи с увеличением нагрузки проблемы, что актуально для нашей системы.

Для мониторинга брокера сообщений применим USE – его будет достаточно, так как в данном случае нет большой необходимости отслеживать HTTP-трафик.

Для мониторинга хранилищ данных не будем придерживаться конкретного подхода, а возьмем минимальный набор метрик, необходимый для обеспечения базовой наблюдаемости.

## Отслеживаемые метрики

Для всех предоставляющих API сервисов будем отслеживать количество запросов в секунду, количество запросов, возвращающих ошибку, а также латентность. Поскольку
предполагается, что MES API будет также выполнять сложные операции расчета стоимости по 3D-моделям, для этого сервиса дополнительно будем отслеживать утилизацию
CPU и RAM.

Такой выбор метрик позволит отслеживать изменение нагрузки во времени, а также сразу определять возникающие ошибки. Дополнительные метрики для MES API помогут оценивать необходимость горизонтального масштабироавния.

MES API:

- Number of requests (RPS)
- Number of HTTP 500
- Response time (latency)
- CPU Utilization
- RAM Utilization

Shop API:

- Number of requests (RPS)
- Number of HTTP 500
- Response time (latency)

CRM API:

- Number of requests (RPS)
- Number of HTTP 500
- Response time (latency)

Для баз данных и хранилища 3D-моделей будем отслеживать их размер и время обработки запросов. Дополнительно для баз данных будем отслеживать утилизацию I/O. Это позволит получать более полное понимание об их состоянии и производительности.

Shop DB:

- Size
- Latency
- I/O Utilization

MES DB:

- Size
- Latency
- I/O Utilization

S3 storage:

- Size
- Latency

Для брокера сообщений будем отслеживать недоставленные сообщения, размеры очередей, а также утилизацию CPU и RAM. Это позволит определять возникшие и потенциальные проблемы, а также косвенно будет отражать состояние консьюмеров.

RabbitMQ:

- Number of dead-letter-exchange letters
- Queue depths
- CPU Utilization
- RAM Utilization

## План действий

Тезисно план внедрения мониторинга будет выглядеть следующим образом:

1. Настройка ClickHouse в качестве time-series хранилища данных;
2. Настройка Prometheus;
3. Настройка агентов-экспортеров на стороне отслеживаемых сервисов;
4. Настройка Grafana для визуализации собираемых данных;
5. Локальное тестирование и отладка;
6. Запуск в prod-окружении.
