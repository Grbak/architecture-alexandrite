# Архитектурное решение по кешированию

## Мотивация

Внедрение кеширования позволит повысить производительноть системы и решить одну из текущих проблем пользователей – медленную загрузку страницы с заказами в MES.

## Предлагаемое решение

В качестве решения предлагается внедрить серверное кеширование – оно позволит снизить латентность запросов от клиентов, ускорив тем самым загрузку страницы в MES. Клиентское кеширование в контексте MES будет менее актуальным, поскольку оно не поспособствует более быстрому получению пользователями информации о новейших заказах. Более того, кеширование на клиенте приведем к тому, что операторы гарантированно будут получать устаревшие данные до инвалидации кеша, что является критичным в контексте текущего бизнес-процесса.

Для ускорения загрузки данных о заказах необходимо внедрить кеширование между сервисом MES API и базой данных MES DB. В качестве паттерна кеширования предлагается использовать паттерн read-through в виду преобладания операций чтения и его простоты.

Диаграмму последовательности действий можно найти [тут](https://editor.plantuml.com/uml/hLNBReCm4Bpp5QlSymCzH7bAoI5AbAZdoeLDOWaCzPgqwTVN2pQlGfj8kR36xEpEB8EPaX7Qv4aS66bYX5cCNq95MXg4dOvGmqA45wdESCIF75M8i9JYh4KI19b5ob1cGXdOhewj-v7TWDb-Cm91_F3Dhbi9N1RvuMAsMA-2I1ZnBWXBu79UuPRpTjt5OLlLjUkYRWq-hdTxZ-OrmmELMZ7frMfnH5vgCUa9qa9cBCc0HX5PhG5p64_gz0Edao4mbhF2JxikOGIdL1Ux9wdjff491Y8qyYfiJw_RHIvPgEM28Y9WtdLsEOZYwfilvyrK8CcKkLjOJ4yIO9APMxkZbLm668ydLSUDaaQAM7uZrHM22BjGrv-H3VacryhnRK1AnfKwXndEz_DuOBvF6MQlc4pZLQOvnRTo5j7pvFrZECh348bEUUoyPxz1anE45w7EVzglczXj3RtJSU32GdbcGmiwOBjNJiJkM8VzTK3AKaL8mvvgUhh9YJ-Xtxo6MtbgZzkuXsBd9K_yeNBFrFtvuoAZtQ4pD3z_9hdePDKTUmXwIDNa3asELvzr1zvIuTifgeX_1Jy0).

UPD: для достижения консистентности данных в MES_DB и SHOP_DB при изменении статуса заказа было решено выбрать механизм компенсационных траназакций. Как это выглядит: при изменении оператором через веб-интерфейс статуса заказа MES_API вносит изменения в MES_DB, а затем синхронно обращается к CRM_API для внесения соответствующих изменений в SHOP_DB (скорее всего механизм компенсационных транзакций можно адаптировать и под асинхронное взаимодействии сервисов, но для простоты выбран именно синхронный вариант из-за отсутствия достаточного опыта работы с очередями). В случае, если CRM_API успешно обновляет данные в SHOP_DB, оператору возвращается ответ с успешным изменением статуса. Если же MES_API получает ошибку от CRM_API, он откатывает ранее внесенные им изменения в MES_DB и возвращает оператору ошибку.

В качестве паттерна инвалидации кеша выберем паттерн на основе изменений – он позволит обновлять данные в кеше каждый раз, когда какой-либо заказ переходит в статус MANUFACTURING_APPROVED или MANUFACTURING_STARTED, сводя задержки минимуму.

| Паттерн             | Плюсы                                     | Минусы                                                         |
| ------------------- | ----------------------------------------- | -------------------------------------------------------------- |
| На основе запросов  | Незначительные задержки                   | Необходимость проверять актуальность кеша при каждом запросе   |
| На основе изменений | Отсутствие задержек, простота реализации  | -                                                              |
| Временная           | Простота реализации                       | Задержки                                                       |
| Программная         | Отсутствие задержек                       | Более трудоемкий в реализации, чем паттерн на основе изменений |
| По ключу            | Удобен при кешировании детализации заказа | Не удобен при кешировнии списка заказов                        |
