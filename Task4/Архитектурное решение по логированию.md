# Архитектурное решение по трейсингу

## Мотивация

Внедрение логирования позволит отслеживать события, возникающие в системе, и использовать эти данные для решения разного рода задач: от поиска потерянного заказа до анализа бизнес-процессов.

В отличие от мониторинга и трейсинга, которые больше направлены на решение проблем "здесь и сейчас", логирование позволит решать проблемы постфактум, а также проводить ретроспективный анализ данных.

Метрики, на которые повлияет внедрение логирования:

- скорость обработки пользовательских заявок на поддержку;
- затраты на поддержку;
- количество инцидентов информационной безопасности.

В случае, если у команды не хватит ресурсов на внедрение и трейсинга, и логирования, предлагается сделать выбор в пользу логирования по следующим причинам:

- логирование возникающих в системе событий будет также давать понимание, в каком месте системы мог затеряться заказ;
- возможность отслеживать время обработки запросов внутри системы для точечных оптимизаций на текущем этапе развития продукта не является критичной – это будет важно тогда, когда архитектура будет приведена в порядок, и текущие критичные проблемы пользователей будут решены;
- ожидается, что внедрение логирования займет меньше времени и потребует меньшей экспертизы, чем внедрение и отладка трейсинга;
- несмотря на то, что хранение логов потребует бОльших затрат, логирование позволит решать проблемы тех заказов, которые трейсинг не будет покрывать в силу меньшего срока хранения данных.

## Какие логи нужно собирать

На первом этапе внедрения логирования предлагается собирать логи следующих уровней:

- INFO: события, связанные с созданием заказов и изменением их статусов, а также события, связанные с созданием и изменением пользователей;
- ERROR: рантайм-ошибки в контроллерах сервисов, а также неудачные ответы от смежных сервисов и хранилищ данных;
- WARN: неудачные попытки входа в сервисах, подразумевающих авторизацию, попытки доступа к данным, не прошедшие авторизацию, а также подозрительные запросы – например, запросы с аномальным размером тела или отсутствием необходимых заголовков.

## Предлагаемое решение

В качестве инструмента логирования предлагается выбрать стек ELK как одно из самых популярных решений, которое полностью покрывает нужды разрабатываемой системы. Обновленную диаграмму контейнеров можно найти [тут](https://app.diagrams.net/#G1hy5X6D47CGnJVUyj7ssecM7UIrOsyaCz#%7B%22pageId%22%3A%22SUggCPOxJ7nFEdAwL4Jo%22%7D).

Для снижения связанных с безопасностью рисков при внедрении логирования необходимо:

- исключать попадание чувствительных данных в логи;
- хранить данные в обезличенном виде – идентификаторы вместо конкретных имен;
- разграничить доступ к логам таким образом, чтобы просматривать их мог ограниченный круг лиц – члены команды разработки;
- обеспечить безопасность при передаче данных между отслеживаемыми компонентами системы и сервисом логирования, например, с использованием шифрования;
- обеспечить безопасность запускаемого сервиса логирования, например, с помощью контейнеризации, а также настроить разграничение доступа на сервере, на котором он запускается.

Для большей производительности необходимо создать индекс под каждый отслеживаемый сервис, а срок хранения определять на основе максимально возможного времени выполнения заказа. Например, если предполагается, что с момента создания до момента завершения заказа может пройти до двух месяцев, хранить логи необходимо не меньше данного периода времени.

Рассчитаем приблизительный объем одной записи:

- дата и время – ~20 символов;
- уровень логирования – до 5 символов;
- cообщение – до 100 символов;
- метаданные - до 30 символов.

Таким образом, длина одной записи в большинстве случаев не будет превышать 20 + 5 + 100 + 30 = 155 символов. Тогда с учетом использования кодировки UTF-8 будем считать, что одна запись будет занимать примерно 155 байт.

Если предположить, что ежедневно система будет логировать 100 000 событий, то ежедневный объем собранных логов составит 15 500 000 байт или ~16 мегабайт, а ежемесячный – ~460 мегабайт.

## Мероприятия для превращения системы сбора логов в систему анализа логов

Для повышения эффективности логирования стоит рассмотреть использование инструментов алертинга и/или поиска аномалий: например, Kibana Alerting или Elasticsearch Watcher.

Настраивать алертинг необходимо в случаях, когда явно требуется ручное вмешательство. Будем считать, что в нашем случае алертинг необходим при:

- возникновении рантайм-ошибок;
- возникновении большого количества неудачных ответов за единцу времени – точный порог определяется эмпирическим путем, для начала можем считать, что критическим значением является 100 ошибок в течение 5 минут.
